#### 代理

##### 普通代理

![image-20220401102916471](\image\image-20220401102916471.png)

如图：代理服务器相当于一个中间人，一直帮两边传递东西

不过它可以在中间可以帮我们过滤、缓存、负载均衡(多台服务器共用一台代理情况下)等一些处理

注意，实际场景中客户端和服务器之间可能有多个代理服务器

##### 隧道代理

客户端通过`CONNECT`方法请求隧道代理创建一个可以到任意目标服务器和端口号的TCP连接，创建成功之后隧道代理只做请求和响应数据的转发，中间它不会做任何处理

![image-20220401103418233](\image\image-20220401103418233.png)

为什么需要隧道代理呢？

我们都知道`https`服务是需要网站有证书的，而代理服务器显然没有，所以浏览器和代理之间无法创建`TLS`，所以就有了隧道代理，它把浏览器的数据原样透传，这样就实现了通过中间代理和服务端进行TLS握手，然后进行加密传输

可能有人会问，那还要代理干嘛，直接请求服务器不是更好吗

#### 代理服务器的优点

```
突破访问限制：如访问一些单位或集团内部资源，或用国外代理服务器(翻墙)，就可以上国外网站看片等

安全性更高：上网者可以通过这种方式隐藏自己的IP，免受攻击。还可以对数据过滤，对非法IP限流等

负载均衡：客户端请求先到代理服务器，而代理服务器后面有多少源服务器，IP是多少，客户端是不知道的。因此，代理服务器收到请求后，通过特定的算法(随机算法、轮询、一致性hash、LUR(最近最少使用) 算法这里不细说了)把请求分发给不同的源服务器，让各个源服务器负载尽量均衡

缓存代理：将内容缓存到代理服务器

```

#### 代理请求头

```
Via：
是一个能用首部，由代理服务器添加，适用于正向和反向代理，在请求和响应首部均可出现，这个消息首部可以用来追踪消息转发情况，防止循环请求，还可以识别在请求或响应传递链中消息发送者对于协议的支持能力
Via: 1.1 vegur
Via: HTTP/1.1 GWA
Via: 1.0 fred, 1.1 p.example.net

X-Forwarded-For：
记录客户端请求的来源IP，每经过一级代理(匿名代理除外)，代理服务器都会把这次请求的来源IP追加进去
X-Forwarded-For: client,proxy1,proxy2

X-Real-IP：
一般记录真实发出请求的客户端的IP，还有X-Forwarded-Host和X-Forwarded-Proto分别记录真实发出请求的客户端的域名和协议名

代理中客户端IP伪造问题以及如何预防？
X-Forwarded-For是可以伪造的，比如一些通过X-Forwarded-For获取到客户端IP来限制刷票的系统就可以通过伪造该请求头达到刷票的目的，如果客户端请求显示指定了X-Forwarded-For：192.168.1.108
```

#### 正向代理

工作在客户端的代理为正向代理。使用正向代理的时候，需要在客户端配置需要使用的代理服务器，正向代理对服务端透明。比如抓包工具Fiddler、Charles以及访问一些外网网站的代理工具都是正向代理

![image-20220401104507077](\image\image-20220401104507077.png)

```
正向代理通常用于

VPN
缓存
屏蔽某些不健康的网站
通过代理访问原本无法访问的网站
上网认证，对用户访问进行授权
```

#### 反向代理

```
工作在服务端的代理称为反向代理。使用反向代理的时候，不需要在客户端进行设置，反向代理对客户端透明。如Nginx就是反向代理。

反向代理通常用于：负载均衡、服务端缓存、流量隔离、日志、金丝雀发布
本地开发服务器跨域，history模式路由404
```

![image-20220401104601115](\image\image-20220401104601115.png)